<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>キャラクター図鑑｜東方英単語録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      background:#0b1020;
      color:#fff;
      padding:20px;
    }
    h1{ margin-bottom:20px; }

    table{
      width:100%;
      border-collapse:collapse;
      background:rgba(255,255,255,.05);
      font-size:14px;
    }
    th, td{
      border:1px solid rgba(255,255,255,.15);
      padding:8px;
      text-align:center;
      vertical-align:middle;
    }
    th{
      background:rgba(255,255,255,.12);
      white-space:nowrap;
    }
    img{
      width:48px;
      height:48px;
      object-fit:contain;
    }
    .skill{
      text-align:left;
      font-size:13px;
      line-height:1.6;
    }

    


  </style>
</head>

<body>
  <h1>キャラクター図鑑</h1>

  <div style="margin-bottom:12px;">
    <button onclick="sortByRare()">レア度</button>
    <button onclick="sortByAttribute()">属性</button>
    <button onclick="sortByHP()">HP</button>
    <button onclick="sortByATK()">攻撃</button>
  </div>


  <table id="charTable">
    <thead>
      <tr>
        <th>画像</th>
        <th>名前</th>
        <th>レア</th>
        <th>属性</th>
        <th>HP</th>
        <th>攻撃</th>
        <th>スキル</th>
        <th>リーダースキル</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>


    let characters = [];


    function sortByRare() {
      characters.sort((a, b) => b.rare - a.rare);
      renderTable();
    }

    function sortByHP() {
      characters.sort((a, b) => b.hp - a.hp);
      renderTable();
    }

    function sortByATK() {
      characters.sort((a, b) => b.atk - a.atk);
      renderTable();
    }

    const ATTRIBUTE_ORDER = ["N", "Adj", "Adv", "V", "Rev"];

    function sortByAttribute() {
      characters.sort((a, b) =>
        ATTRIBUTE_ORDER.indexOf(a.attr) - ATTRIBUTE_ORDER.indexOf(b.attr)
      );
      renderTable();
    }
    
    const ATTRIBUTE_MAP = {
      N:   { label: "名詞", icon: "img/attribute/N.png" },
      Adj: { label: "形容詞", icon: "img/attribute/Adj.png" },
      Adv: { label: "副詞", icon: "img/attribute/Adv.png" },
      V:   { label: "動詞", icon: "img/attribute/V.png" },
      Rev: { label: "反転動詞", icon: "img/attribute/Rev.png" }
    };

    function renderAttribute(attr) {
      const info = ATTRIBUTE_MAP[attr];
      if (!info) return attr;

      return `
        <img
          src="${info.icon}"
          alt="${info.label}"
          title="${info.label}"
          style="
            width:32px;
            height:32px;
            object-fit:contain;
          "
        >
      `;
    }


    // ★ CSVを「カンマを無視して」正しく分割する関数
    function parseCSV(line) {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          result.push(current);
          current = "";
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function renderTable() {
      const tbody = document.querySelector("#charTable tbody");
      tbody.innerHTML = "";

      for (const c of characters) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="img/characters/${c.image}.png" alt=""></td>
          <td>${c.name}</td>
          <td>★${c.rare}</td>
          <td>${renderAttribute(c.attr)}</td>
          <td>${c.hp}</td>
          <td>${c.atk}</td>
          <td class="skill">${c.skill}</td>
          <td class="skill">${c.leader}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    fetch("data/GachaCharacterData.csv")
      .then(res => res.text())
      .then(csv => {
        const lines = csv.trim().split("\n");
        const headers = parseCSV(lines[0]).map(h => h.trim());

        const idx = name => headers.indexOf(name);

        characters = []; // ★ まず空にする

        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSV(lines[i]);

          characters.push({
            name: cols[idx("Name")],
            hp: Number(cols[idx("BaseHP")]),
            atk: Number(cols[idx("BaseAttack")]),
            rare: Number(cols[idx("rare")]),
            attr: cols[idx("Attribute")],
            image: cols[idx("Image")],
            skill: cols[idx("スキル文章")],
            leader: cols[idx("リーダースキル文章")]
          });
        }

        renderTable(); // ★ 最初の描画はここで1回だけ

      });
  </script>
</body>
</html>
